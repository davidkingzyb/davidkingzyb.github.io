<!DOCTYPE html>
<html>

<head>
    <title>DKZ's Blog</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=0.8, minimum-scale=0.8, maximum-scale=0.8, user-scalable=no" />
    <link rel="stylesheet" type="text/css" href="../res/md.css">
    <link rel="stylesheet" type="text/css" href="../res/blogstyle.css">
    <script type="text/javascript" src="../res/dkzlogo.js"></script>
</head>

<body>
    <div id="footer">
        <div id="footerPane">
            <a href="../blogmd/1.html"><img id="cubehead" src="../res/img/cubehead.png"></a>
            <div id="footerL">
                <!-- <a class="btn" href="../home.html">Home</a> -->
                <a class="btn" href="//davidkingzyb.tech">Home</a><a id="rssbtn" href="../rss.xml" class="btn">RSS</a>
            </div>
            <div id="footerR">
                <a class="btn" href="https://github.com/davidkingzyb/davidkingzyb.github.io/issues/1" id="discussbtn">Discuss</a><a class="btn" href="../blog.html">Contents</a><a class="btn" href="#top">Top</a>
            </div>
        </div>
    </div>
    <div id="container">
        <a href="#top">
            <div id="headPane">
                <div id="headmain">
                    <canvas id="dkzlogo" width="340" height="250">
                        <img src="../res/img/dkzlogo.png">
                    </canvas>
                </div>
                <script type="text/javascript" src="../res/blogmd.js"></script>
            </div>
        </a>
        <div id="bodyPane">
<article class="markdown-body"><h1><a class="anchor" name="%E7%82%BC%E4%B8%B9%E7%82%BC%E4%B8%B9"><span class="octicon octicon-link"></span></a>炼丹炼丹</h1>

<p><strong>Stable Diffusion LoRA 训练心得</strong></p>

<p>2024/3/11 by DKZ</p>

<p><img src="./blogImg/48-1.jpeg" alt="ZengXinStyle"></p>

<p><img src="./blogImg/48-2.jpeg" alt="ZengXinStyle">
<img src="./blogImg/48-3.jpeg" alt="ZengXinStyle">
<img src="./blogImg/48-4.jpeg" alt="ZengXinStyle"></p>

<p>最近沉迷炼丹，用我爸爸的绘画作品训练了一个<a href="https://civitai.com/models/337209/zengxinstyle">LoRA</a>。发现炼丹这个比喻真的很恰当，各种参数之间的关系类似玄学，训练本身则更像一个试错的过程。AI也是一样，在查了一堆资料之后似乎搞明白了扩散模型，以及图片训练和生成的过程，但真要问原理是啥我想我答不上来。可能AI研究本身就是探究人类的智能尝试复原人类的认知结构，而这个结构可能只是从混沌中演化出来的。所以不敢说真的悟出了什么道理，只是有些失败的教训给各位道友分享，希望各位少走弯路。 </p>

<p>使用的工具是<a href="https://github.com/bmaltais/kohya_ss">kohya_ss</a>这个工具。 </p>

<p>打标是非常关键的一步使用 wd14 ，和我自己做的一个<a href="https://github.com/davidkingzyb/SimpleTaggerEditor">手动打标插件</a>。另外数据集的选择非常关键，由于我爸爸的画作并非具象写实的那一派，很多画面的元素不能被很好的提取tag，而且在图片生成时提示词的作用也不是很明显。所以我尝试把同意题材的作品放入一个数据集中训练，这样在使用的时候，这个lora也能充当触发提示词的作用。另外训练数据集的大小也是一个相当关键的参数，直接影响到训练的步数效率和训练结果。</p>

<p>底模选择stable diffusion v1.5，因为大的底模需要显存更高，训练时间更久，一些混合模型或微调过的模型又可能没啥普适性。  </p>

<p>训练LoRA方式尝试了，iA3，loHa，loKr。iA3得出的LoRA很小，效果还行，而且需要调的参数很少，推荐入门可以尝试，但在comfyUI上使用出现了一些问题。loha和lokr可以自己选择参数，我的建议是从默认参数开始，根据需要调整。另外不要试图通过控制变量的方法穷举出最好的效果，这些参数之间存在一些微妙的联系，我愿称之为玄学，改变一定量有时可能会产生巨大反应，有时可能一点效果没有。  </p>

<p>最后我想说在绘画上，对于好的定义，本来就是模糊的。对应AI风格训练也应如此，loss最小不代表最好或者最像。有时这事要随缘，各位道友切莫强求，以免坏了道心。  </p>

<p>以下是参数部分，是个人经验，只针对曾新油画作品风格学习：</p>

<h3><a class="anchor" name="%E6%AD%A5%E9%95%BF%EF%BC%88steps%EF%BC%89"><span class="octicon octicon-link"></span></a>步长（steps）</h3>

<p><code>steps=(image_nums*repeat)*epochs/batch_size</code></p>

<p>这个公式包含四个非常重要的参数，这四个参数会直接影响需要训练的步数，步数就是时间就是效率，也直接关系到学习的好坏。<br>
- image<em>nums：和数据集有关，不要太大超过100可以分成两个，我一般是60-80<br>
- repeat：可以高一点20-30，不能太低了<br>
- epochs：因为设置每隔n个轮次保存，所以可以用这个控制最终steps。太高会糊，浪费时间，可以看sample手动中断。（可配合余弦退火防止炼糊）<br>
- batch</em>size:同时训练几张图片，会提高显存占用，受到显存限制我一般设为2  </p>

<h3><a class="anchor" name="%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%88lr%EF%BC%89"><span class="octicon octicon-link"></span></a>学习率（lr）</h3>

<p>选定了优化器后使用默认的就好，选Prodigy设为1可以自动调整学习率，另外LR Scheduler选cosine<em>with</em>restarts，可以在同一次训练中得到更多不同的效果。</p>

<h3><a class="anchor" name="%E7%A7%A9%EF%BC%88rank%EF%BC%89"><span class="octicon octicon-link"></span></a>秩（Rank）</h3>

<p>这个参数会关系到LoRA的大小，更大可能容纳更多东西？一般默认就好。<br>
另一个有关的是Alpha，学的不像可以提高Rank，降低Alpha，过拟合可以降低Rank，提高Alpha。
还有一些和精度相关的，我也推荐默认参数。  </p>
</article><div class="markdown-body" id="discusspane">
    <a href="https://github.com/davidkingzyb/davidkingzyb.github.io/issues/1" class="btn">Discuss</a>
    <a href="../blog.html?year=2024" class="btn">2024</a>
    <a href="../blog.html?year=2023" class="btn">2023</a>
    <a href="../blog.html?year=2022" class="btn">2022</a>
    <a href="../blog.html?year=2021" class="btn">2021</a>
    <a href="../blog.html?year=2020" class="btn">2020</a>
    <a href="../blog.html?year=2019" class="btn">2019</a>
    <a href="../blog.html?year=2018" class="btn">2018</a>
    <a href="../blog.html?year=2017" class="btn">2017</a>
    <a href="../blog.html?year=2016" class="btn">2016</a>
    <a href="../blog.html?year=2015" class="btn">2015</a>
    <div id="copyright">&copy;2015-2024 by DKZ</div>
</div>
</div>
</div>
</body>

</html>
