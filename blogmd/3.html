<!DOCTYPE html>
<html>
<head>
	<title>DKZ's Blog</title>
	<meta charset="utf-8">
	<meta name="viewport"
          content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"/>
	<link rel="stylesheet" type="text/css" href="../res/md.css">
	<link rel="stylesheet" type="text/css" href="../res/style.css">
	<script type="text/javascript" src="blogImg/blogmd.js"></script>
</head>
<body>
	<div id="container">
		<a href="#top">
			<div id="headPane">
			<div id="headmain">
				<canvas id="dkzlogo" width="340" height="250">
					<img src="/res/img/dkzlogo.png">
				</canvas>
			</div>

		</div>
		</a>
		<div id="bodyPane"><article class="markdown-body"><h1>
<a id="user-content-paypal支付" class="anchor" href="#paypal%E6%94%AF%E4%BB%98" aria-hidden="true"><span class="octicon octicon-link"></span></a>PayPal支付</h1>

<p><strong>PayPal支付和PayPal-python-SDK使用</strong></p>

<p>2015/8/1 by DKZ</p>

<p>PayPal提供完善的支付接口和<a href="https://developer.paypal.com/docs/">文档支持</a></p>

<p>在构建一个支付系统之前，首先要在PayPal上注册个人高级账号并创建应用，PayPal会提供唯一的client_id和client_secret供构建支付使用。执行支付之前PayPal要求使用client_id和client_secret获得一个access token，通过这个access token就可以调用PayPal的支付接口了。</p>

<p>PayPal支付流程主要分为以下三步：</p>

<ol>
<li>创建并向PayPal传送一个支付请求。</li>
<li>跳转到PayPal页面，PayPal引导用户完成支付。</li>
<li>支付成功跳转至支付处理成功界面或支付失败跳转到支付失败界面。</li>
</ol>

<h2>
<a id="user-content-paypal-python-sdk介绍及使用" class="anchor" href="#paypal-python-sdk%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BD%BF%E7%94%A8" aria-hidden="true"><span class="octicon octicon-link"></span></a>PayPal-python-SDK介绍及使用</h2>

<p>PayPal为开发者提供多种编程语言的SDK，其中封装了PayPal的支付接口，直接供用户调用完成支付。<a href="https://github.com/paypal/PayPal-Python-SDK">查看更多SDK使用方法和说明</a>。</p>

<h3>
<a id="user-content-使用client_id和client_secret获得access-token" class="anchor" href="#%E4%BD%BF%E7%94%A8client_id%E5%92%8Cclient_secret%E8%8E%B7%E5%BE%97access-token" aria-hidden="true"><span class="octicon octicon-link"></span></a>使用client_id和client_secret获得access token：</h3>

<pre><code>import paypalrestsdk
paypalrestsdk.configure({
    'mode': 'sandbox',
    'client_id': 'AQkquBDf1zctJOWGKWUEtKXm6qVhueUEMvXO_-MCI4DQQ4-LWvkDLIN2fGsd',
    'client_secret': 'EL1tVxAjhT7cJimnz5-Nsx9k2reTKSVfErNQF-CmrwJgxRtylkGTKlU4RvrX'
})
</code></pre>

<p>其中mode为支付环境，可以选择sandbox沙箱环境供测试使用或live环境进行真实的支付请求。服务器会返回一个json类型值：</p>

<pre><code>{"scope":"https://api.paypal.com/v1/payments/.* email https://api.paypal.com/v1/vault/credit-card openid https://uri.paypal.com/services/invoicing https://api.paypal.com/v1/developer/.* https://api.paypal.com/v1/vault/credit-card/.*","access_token":"A015xIqJSci5-6gjr9Z2KrjXi12zYoNML-xH12oi7w15pjg","token_type":"Bearer","app_id":"APP-80W284485P519543T","expires_in":28800}
</code></pre>

<p>其中包括access token。</p>

<h3>
<a id="user-content-创建一个支付" class="anchor" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%94%AF%E4%BB%98" aria-hidden="true"><span class="octicon octicon-link"></span></a>创建一个支付：</h3>

<pre><code>payment = paypalrestsdk.Payment({
    "intent": "sale",
    "payer": {
        "payment_method": "paypal" 
    },
    "redirect_urls": {
        "return_url": "https://devtools-paypal.com/guide/pay_paypal/python?success=true",
        "cancel_url": "https://devtools-paypal.com/guide/pay_paypal/python?cancel=true" 
    },
    "transactions": [ {
        "amount": {
            "total": "12",
            "currency": "USD" 
        },
        "description": "creating a payment" 
    }] 
})
payment.create()
</code></pre>

<p>向Payment方法中传递intent、payer、transactions参数，其中payer中包含“payment_method”、“return_url”、“cancel_url”分别对应支付方法、支付成功跳转地址、支付失败跳转地址，可使用的支付方法包括“paypal”PayPal账户和“credit_card”信用卡。Transactions中包含具体的支付订单信息，包括“total”总计、“currency”使用货币、“description”描述等。
payment.create()方法会返回一个boolean值，如果为false则订单创建失败，如果为true服务器会返回json类型的定单详情：</p>

<pre><code>{"id":"PAY-8LP54154BP414945AKUPJ37Y","create_time":"2015-04-03T14:04:47Z","update_time":"2015-04-03T14:04:47Z","state":"created","intent":"sale","payer":{"payment_method":"paypal","payer_info":{"shipping_address":{}}},"transactions":[{"amount":{"total":"12.00","currency":"USD","details":{"subtotal":"12.00"}},"description":"creating a payment","related_resources":[]}],"links":[{"href":"https://api.sandbox.paypal.com/v1/payments/payment/PAY-8LP54154BP414945AKUPJ37Y","rel":"self","method":"GET"},{"href":"https://www.sandbox.paypal.com/cgi-bin/webscr?cmd=_express-checkout&amp;token=EC-15P25616UF798962P","rel":"approval_url","method":"REDIRECT"},{"href":"https://api.sandbox.paypal.com/v1/payments/payment/PAY-8LP54154BP414945AKUPJ37Y/execute","rel":"execute","method":"POST"}]}
</code></pre>

<p>其中“links”数组中的第二个元组包含应跳转的PayPal页面地址。</p>

<h3>
<a id="user-content-支付成功处理" class="anchor" href="#%E6%94%AF%E4%BB%98%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86" aria-hidden="true"><span class="octicon octicon-link"></span></a>支付成功处理</h3>

<p>用户在PayPal页面中完成支付后，PayPal会自动跳转回之前设定的支付请求成功处理页面并将paymentId和payerID以参数的形式传递给页面。</p>

<pre><code>payment = paypalrestsdk.Payment.find("PAY-57363176S1057143SKE2HO3A")
if payment.execute({"payer_id": "DUFRQ8GWYMJXC"}):
    print("Payment execute successfully")
else:
    print(payment.error)
</code></pre>

<p>使用payment.find(paymentId)方法查找订单并使用payment.execute(paymentId,payerID)方法执行订单加入支付用户信息。payment.execute方法会返回一个boolean值，若为true则代表处理成功，false为处理失败。</p>
</article>
<article class="markdown-body">
<!-- 多说评论框 start -->
	<div id="discusspane"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"davidkingzyb"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->

</article>
</div>
	</div>
<div id="footer">
	<div id="footerPane">
		<img id="cubehead" src="../res/img/cubehead.png">
		<div id="footerL">
			<a href="../index.html">Home</a><a href="../index.html#contact">Contact</a>
		</div>
		<div id="footerR">
			<a id="search">Search</a><a href="../blog.html">Contents</a><a href="#top">Top</a>
		</div>

	</div>
</div>
</body>
</html>